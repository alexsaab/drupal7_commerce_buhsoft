**Модуль для Drupal 7 и Commerce для работы с сервисом для онлайн кассы Бухсофт (Buhsoft)**

1. Для установки модуля просто скопируйте его в директорию "sites/all/modules/commerce_buhsoft". Эту директорию предварительно конечно необходимо создать. Если у вас "мультисайтовый" Drupal и вы хотите ставить модуль на определенный сайт скопируйте его в папку "sites/url вашего сайта.ru/modules/commerce_buhsoft". 
2. Включите его через "admin/modules" или с помощью утилиты drush команда "drush en commerce_buhsoft". У вас в базе данных создадутся необходимые поля и сущности в заказах commerce и профилях пользователя (в частности в профайле доставки у вас создасться поле phone - телефон, для работы с сервисом Бухсофт это обязательный параметр).
3. Далее настраиваем модуль через меню "admin/commerce/config/advanced-settings/commerce_buhsoft" никаких трудностей в настройке модуля нет. Только, если у вас на сайте продаются несколько товаров с разными ставками НДС вам для каждого такого товара необходимо создать отдельный тип. Также необходимо выбрать тип оплаты через, который(ые) в автоматическом режиме будут автоматически пробиваться онлайн чеки через сервис Бухсофта. Также обратите внимание на параметр Token (Токен), он обязательный, как только его введете и сохраните форму, у вас будет показываться статус онлайн кассы. 
4. Теперь если все заработало и сервер выдает статус кассы, включен проверяем в любом заказе в форме его редактирования, например, тут: admin/commerce/orders/5/edit (где 5 это номер заказа) должна появится кнопка внизу формы "To Buhsoft checkout" - если ее нет, то смотрите какой статус заказа вы выставили в форме установке модуля. Он должен совпадать. Потом, если мы нажмем на кнопку "To Buhsoft checkout" пробъется чек в онлан кассе.
5. Очень важно везде установить цены как для товара, так и для доставки или услуги в рублях. Если валюта в заказе будет отличаться в какой либо позиции от RUB (код валюты по ISO) то чек не пробъется, а Drupal в log (wachdog) выдаст соответсвующую ошибку. 
6. Далее чеки можно пробивать и автоматически, только нужно настроить все правильно. В Drupal Commerce автоматическое пробитие чека работает в связке с модулем Rules (у вас по умолчанию должен быть включен модуль Rules UI). 

6.1. Если все ключено правильно идем сюда "/admin/config/workflow/rules": там видим правило, типа: "Commerce order message: payment entered / Machine name: rules_commerce_order_message_payment_entered" вот оно, что нам нужно, это правило срабатывает после полной оплаты заказа, мы по правилам торговли в течение 5 минут криенту должны пробить чек. Как только оплата поступает мы пробиваем чек. Переходим на редактирование данного правила, добавляем новое действие "Add a new action". Далее выбираем в группе "Commerce Payment" действие "Buhsoft online checkout". 

6.2. Действие имеет только один селектор для передачи в функцию оплаты Buhsoft выбираем "commerce-payment-transaction:order" 

6.3. Когда оплата поступает от клиента, то есть выполняется правило: rules_commerce_order_message_payment_entered выбивается чек в системе Бухсофт - профит!!!


По всем вопросам работы и доработки модуля вы можете обратиться непосредственно ко мне awa77@mail.ru 

  


